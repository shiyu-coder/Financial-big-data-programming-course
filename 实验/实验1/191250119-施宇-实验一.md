# 实验一：MPI Programming

施宇 191250119

[TOC]

## 尝试在单机上安装并运行MPI环境。（MPICH或者OpenMPI等）

共安装了两套单机环境和一套多机环境：

### 单机环境：Visual Studio 2019 + MSMPI

编译环境：

![image-20210915085549850](C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915085549850.png)

运行环境：

![image-20210915090547143](C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915090547143.png)

### 单机环境：Vscode + MSMPI

编译运行：

![image-20210915090700599](C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915090700599.png)

### 多机环境：Windows11家庭版 + WSL2 + Docker

详细环境配置过程见**附录A**

在三个节点上运行hellompi程序：

![image-20210915091014318](C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915091014318.png)

当并行数为5时，三个节点都参与工作，且任务数量按顺序平均分配。

## 编程1

## 编程2

## 尝试在多个节点上运行上述MPI程序，可设置不同的进程数对结果进行比较，并评估所需时间。

## 附录A

**多机环境(Windows11家庭版 + WSL2 + Docker)配置：**

### 安装Hyper-V

由于WSL2需要Hyper-V组件提供虚拟机支持，而该组件只有Windows专业版上才有，因此在Windows家庭版上需要手动下载安装该组件。

将下面的内容添加到记事本中：

```shell
pushd "%~dp0"

dir /b %SystemRoot%\servicing\Packages\*Hyper-V*.mum >hyper-v.txt

for /f %%i in ('findstr /i . hyper-v.txt 2^>nul') do dism /online /norestart /add-package:"%SystemRoot%\servicing\Packages\%%i"

del hyper-v.txt

Dism /online /enable-feature /featurename:Microsoft-Hyper-V-All /LimitAccess /ALL
```

然后另存为Hyper-V.cmd文件，右键该文件以管理员身份执行，待下载结束后输入Y重启，完成Hyper-V的安装。

### 安装WSL2

下载Linux内核更新包：

https://links.jianshu.com/go?to=https%3A%2F%2Fwslstorestorage.blob.core.windows.net%2Fwslblob%2Fwsl_update_x64.msi

运行下载的更新包。 （双击以运行 - 系统将提示提供提升的权限，选择“yes”以批准此安装。）

打开终端输入下方命令，将WSL默认版本设置为WSL2

```shell
wsl --set-default-version 2
```

打开Microsoft Store下载Linux发行版：

这里我选择的是Ubuntu18.04：

<img src="C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915092207666.png" alt="image-20210915092207666" style="zoom:67%;" />

安装完成后在菜单栏找到点击运行，输入用户名密码后即可进入Ubuntu终端。

在Windows终端中输入`wsl -l -v`检查是否是WSL2版本。

### 安装Docker

配置阿里云镜像，`/etc/apt/sources.list`文件的内容替换如下：

```shell
deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
 
deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
 
deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
 
deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
 
deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
```

更新源：

```shell
sudo apt-get update
```

安装Docker：

```shell
sudo apt-get remove docker docker-engine docker.io
sudo apt-get update
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo apt-key fingerprint 0EBFCD88
sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"
sudo apt-get update
sudo apt-get install docker-ce
```

测试docker是否安装成功：

```shell
docker version
```

添加用户：

```shell
sudo adduser $USER docker
```

启动docker服务：

```shell
sudo service docker restart
```

测试docker能否正常运行：

```shell
sudo docker run hello-world
```

如果提示：Cannot connect to the Docker daemon at ……则还需要以下操作：

关闭wsl窗口，重新右键以管理员身份运行：

<img src="C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915100850182.png" alt="image-20210915100850182" style="zoom:80%;" />

然后执行以下命令：

```shell
sudo apt-get install cgroupfs-mount
sudo cgroupfs-mount
sudo service docker restart
```

再次运行测试命令：

```shell
sudo docker run hello-world
```

运行成功：

![image-20210915101315774](C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915101315774.png)

### 多机MPI配置

这里使用ubuntu:18.04作为节点镜像：

```shell
docker pull ubuntu:18.04
```

拉取镜像之后，需要对基础镜像进⾏环境的配置，在此之前先进⾏换源

开启⼀个容器:

```shell
docker run -dit --hostname origin --name origin ubuntu:18.04
```

进入容器：

```
docker exec -it origin bash
```

安装一下sudo和vim：

```shell
apt-get install sudo
sudo apt-get install vim
```

切换阿里云的源：

```shell
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
sudo vim /etc/apt/sources.list
```

替换为以下内容：

```shell
deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
 
deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
 
deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
 
deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
 
deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
```

更新源：

```shell
sudo apt-get update
```

安装MPI：

```shell
sudo apt-get install libopenmpi-dev
sudo apt-get install openmpi-bin
```

检查是否安装成功：

```shell
mpirun --version
```

安装ssh：

```shell
sudo apt-get install openssh-server
```

尝试ssh一下自己，应该会要求输密码，三次回车即可（拒绝访问）：

```shell
ssh localhost
```

到~/目录下，检查是否有.ssh文件夹：

```shell
ll
```

进入该文件夹，然后应该能找到authorized_keys文件。

修改authorized_keys文件权限为700：

```shell
sudo chmod 700 authorized_keys
```

修改.ssh目录权限为600：

```shell
cd ..
sudo chmod 600 .ssh
```

Ctrl+Q+P退出当前镜像。

创建新镜像：

```shell
docker commit -a <作者名字> origin mpi-ubuntu:latest
```

罗列出本地镜像，看是否创建成功:

```shell
docker images
```

通过挂在本地文件夹的方式运行容器（这里以四个为例）：

```shell
docker run -dit --hostname host1 --name mpi-host1 -v ~/mpidir:/root/mpidir mpi-ubuntu:latest
docker run -dit --hostname host2 --name mpi-host2 -v ~/mpidir:/root/mpidir mpi-ubuntu:latest
docker run -dit --hostname host3 --name mpi-host3 -v ~/mpidir:/root/mpidir mpi-ubuntu:latest
docker run -dit --hostname host4 --name mpi-host4 -v ~/mpidir:/root/mpidir mpi-ubuntu:latest
```

进入host1：

```shell
docker exec -it mpi-host1 bash
```

启动ssh服务：

```shell
service ssh start
```

打开hosts文件：

```shell
sudo vim /etc/hosts
```

可以看到文本中最后一行为：

```shell
172.17.0.2      host1
```

前⾯是ip地址（也是本容器的地址），后⾯是主机名（可以看作是ip的别名，可以⽤它来代替ip地址的书写）

在后面添加host2，host3和host4的ip地址和主机名：

```
172.17.0.3      host2
172.17.0.4      host3
172.17.0.5      host4
```

到~/.ssh目录中，在当前目录下生成密钥（输完命令后直接三次回车，不要做其他操作）：

```shell
ssh-keygen -t rsa
```

然后会发现生成了id_rsa.pub文件，将该文件复制到挂载目录~/mpidir中：

```shell
cp id_rsa.pub ~/mpidir
```

退出当前脚本镜像，分别进入host2， host3， host4，进行如下操作：

启动ssh服务：

```shell
service ssh start
```

进入~/mpidir目录，执行下方命令，将host1的公钥加入到其他子节点的authorized_keys中，设置免密ssh登录：

```shell
cat id_rsa.pub >> ~/.ssh/authorized_keys
```

退出当前镜像。

全部执行完成后，进入host1：

依次检查能够免密ssh连接host2，host3和host4（连接后通过Ctrl+D退出）：

```shell
ssh root@host2
ssh root@host3
ssh root@host4
```

如果都能成功连接，则测试hellompi程序运行：

```shell
mpicc hellompi.c -o hellompi
mpirun -np 10 -host host2,host3,host4 hellompi
```

如果报错：

![image-20210915105010196](C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915105010196.png)

加上参数`--allow-run-as-root`。

如果报错：

![image-20210915105059650](C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915105059650.png)

则说明mpi自动检测判断当前cpu不适合以给定的并行数执行，这里选择添加参数`-oversubscribe`来强制执行。最终的执行命令如下：

```shell
sudo mpirun --allow-run-as-root -oversubscribe -np 5 -host host2,host3,host4 hellompi
```

执行成功：

![image-20210915105235699](C:\Users\86137\AppData\Roaming\Typora\typora-user-images\image-20210915105235699.png)

环境配置结束。